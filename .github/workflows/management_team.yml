name: Management Team CI/CD

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better context

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸ” Verify installation
      run: |
        python --version
        pip list

    - name: ðŸ§ª Run validation tests
      run: |
        echo "Running validation tests..."
        python cli/manage.py validate
      continue-on-error: false

    - name: ðŸ“Š Show system status
      if: always()
      run: |
        python cli/manage.py list
        if [ -d "outputs/reports" ]; then
          python cli/manage.py status || echo "No previous build summaries"
        fi

    - name: ðŸš€ Run full pipeline (if not PR)
      if: github.event_name != 'pull_request'
      run: |
        echo "Running full Management Team pipeline..."
        python cli/manage.py run || echo "Pipeline completed with warnings"
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}

    - name: âœ… Final validation
      if: github.event_name != 'pull_request'
      run: |
        python cli/manage.py validate

    - name: ðŸ“¤ Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: management-team-artifacts-${{ github.run_number }}
        path: |
          outputs/
          logs/
        retention-days: 30
        if-no-files-found: warn

    - name: ðŸ“‹ Generate summary
      if: always()
      run: |
        echo "## ðŸŽ¯ Management Team CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "outputs/reports" ]; then
          LATEST_VALIDATION=$(ls -t outputs/reports/validation_report_*.md 2>/dev/null | head -1)
          if [ -f "$LATEST_VALIDATION" ]; then
            echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -A 5 "Valid Files:" "$LATEST_VALIDATION" >> $GITHUB_STEP_SUMMARY || true
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ¤– Auto-commit build summary (main only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && success()
      run: |
        if [ -d "outputs/reports" ]; then
          LATEST_SUMMARY=$(ls -t outputs/reports/build_summary_*.md 2>/dev/null | head -1)
          if [ -f "$LATEST_SUMMARY" ]; then
            cp "$LATEST_SUMMARY" build_summary_latest.md
            
            git config user.name "management-team-bot"
            git config user.email "bot@managementteam.ai"
            git add build_summary_latest.md
            
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "ðŸ¤– Auto-update: Latest build summary [skip ci]"
              git push
            fi
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ðŸŽ¨ Check code formatting with Black
      run: |
        echo "Checking code formatting..."
        black --check --diff .
      continue-on-error: true

    - name: ðŸ” Lint with Ruff
      run: |
        echo "Running Ruff linter..."
        ruff check . --output-format=github
      continue-on-error: true

    - name: ðŸ§ª Run tests with pytest
      run: |
        echo "Running test suite..."
        pytest tests/ -v --cov --cov-report=term-missing --cov-report=xml
      continue-on-error: true

    - name: ðŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

    - name: ðŸ“Š Code Statistics
      run: |
        echo "## ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Statistics" >> $GITHUB_STEP_SUMMARY
        echo "**Python files:** $(find . -name '*.py' -not -path './venv/*' -not -path './.venv/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "**Total lines:** $(find . -name '*.py' -not -path './venv/*' -not -path './.venv/*' -exec cat {} \; | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Quality Checks" >> $GITHUB_STEP_SUMMARY
        echo "- Black formatting: See above" >> $GITHUB_STEP_SUMMARY
        echo "- Ruff linting: See above" >> $GITHUB_STEP_SUMMARY
        echo "- Pytest tests: See above" >> $GITHUB_STEP_SUMMARY

  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ“š Verify documentation
      run: |
        echo "Checking required documentation..."
        
        REQUIRED_DOCS=(
          "README.md"
          "SYSTEM_100_PERCENT_COMPLETE.md"
          "docs/system/PRD.md"
          "QUICK_START.md"
        )
        
        MISSING=0
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc"
          else
            echo "âŒ Missing: $doc"
            MISSING=$((MISSING+1))
          fi
        done
        
        if [ $MISSING -gt 0 ]; then
          echo "âš ï¸ Warning: $MISSING required documentation file(s) missing"
        else
          echo "âœ… All required documentation present"
        fi

    - name: ðŸ“‹ Generate documentation summary
      run: |
        echo "## ðŸ“š Documentation Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Markdown files:** $(find . -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "**YAML files:** $(find . -name '*.yaml' -o -name '*.yml' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "**Python files:** $(find . -name '*.py' -not -path './venv/*' | wc -l)" >> $GITHUB_STEP_SUMMARY

