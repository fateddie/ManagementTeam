# GitHub Actions Workflow: Deploy MkDocs Documentation
# Automatically builds and deploys documentation to GitHub Pages
# Triggers: On push to main branch or manual dispatch

name: Deploy Documentation

# Trigger conditions
on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'requirements-docs.txt'
      - '.github/workflows/deploy-docs.yml'

  # Allow manual trigger
  workflow_dispatch:

# Permissions for GitHub Pages deployment
permissions:
  contents: write  # Required for gh-pages deployment
  pages: write
  id-token: write

# Job definition
jobs:
  deploy:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git-revision-date plugin

      # Step 2: Set up Python
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache pip dependencies

      # Step 3: Cache MkDocs build
      - name: ðŸ’¾ Cache MkDocs Build
        uses: actions/cache@v4
        with:
          path: |
            .cache
            site/
          key: mkdocs-${{ runner.os }}-${{ hashFiles('mkdocs.yml', 'requirements-docs.txt') }}
          restore-keys: |
            mkdocs-${{ runner.os }}-

      # Step 4: Install dependencies
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-docs.txt

      # Step 5: Validate MkDocs configuration
      - name: âœ… Validate MkDocs Config
        run: |
          mkdocs build --strict --verbose

      # Step 6: Deploy to GitHub Pages
      - name: ðŸš€ Deploy to GitHub Pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdocs gh-deploy --force --clean --verbose

      # Step 7: Create deployment summary
      - name: ðŸ“Š Create Deployment Summary
        if: success()
        run: |
          echo "## ðŸš€ Documentation Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Documentation URL:** https://fateddie.github.io/ManagementTeam/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed from:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Documentation Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Material for MkDocs theme (2026 features)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Full-text search + vector/semantic search" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dark/light mode toggle" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code copy buttons" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Navigation tabs & search highlighting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Last updated timestamps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Documentation](https://fateddie.github.io/ManagementTeam/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Quick Start](https://fateddie.github.io/ManagementTeam/QUICKSTART/)" >> $GITHUB_STEP_SUMMARY
          echo "- [System Architecture](https://fateddie.github.io/ManagementTeam/ARCHITECTURE/)" >> $GITHUB_STEP_SUMMARY

      # Step 8: Notify on failure
      - name: âŒ Notify Failure
        if: failure()
        run: |
          echo "## âŒ Documentation Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check mkdocs.yml for syntax errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Validate all navigation paths exist" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`mkdocs build --strict\` locally to reproduce" >> $GITHUB_STEP_SUMMARY
          echo "4. Check requirements-docs.txt for missing dependencies" >> $GITHUB_STEP_SUMMARY

# Concurrency settings (cancel in-progress deployments)
concurrency:
  group: docs-deployment
  cancel-in-progress: true
